<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>내 정보</title>
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

  <style>
    .profile-container {
      width: 50%;
      margin: 2rem auto;
      border: 1px solid #ddd;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .profile-item {
      margin-bottom: 1.5rem;
      padding: 0.5rem 0;
    }

    .profile-item label {
      font-weight: bold;
      display: inline-block;
      width: 150px;
      margin-bottom: 0.5rem;
    }

    .field-input {
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-right: 0.5rem;
      width: 250px;
    }

    button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      margin-left: 0.5rem;
    }

    button:hover {
      background-color: #0056b3;
    }

    .warning-text {
      color: red;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
  </style>

  <style>
    .password-change-section {
      margin: 20px 0;
    }

    .password-inputs {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 10px 0;
    }

    .password-row {
      display: flex;
      gap: 10px;
    }

    .password-field {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 200px;
    }

    .password-change-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      margin-left: 0.5rem;
    }

    .password-change-btn:hover {
      background-color: #0b5ed7;  /* 좀 더 진한 파란색 */
    }

    .password-change-btn:active {
      background-color: #0a58ca;  /* 클릭시 색상 */
    }
  </style>

  <script>
    // 다음 주소 API 연동
    function openPostcodePopup() {
      new daum.Postcode({
        oncomplete: function(data) {
          const addressField = document.querySelector("#addressField");
          const postcodeField = document.querySelector("#postcodeField");
          const detailAddressField = document.querySelector("#detailAddressField");

          addressField.value = data.address;
          postcodeField.value = data.zonecode;
          detailAddressField.value = "";
          detailAddressField.removeAttribute("readonly");
          detailAddressField.focus();
        }
      }).open();
    }

    // 수정 모드 토글
    function toggleEdit(button) {
      const item = button.closest(".profile-item");
      const displaySpan = item.querySelector(".field-display");
      const inputField = item.querySelector(".field-input");
      const saveButton = item.querySelector(".save-button");

      displaySpan.style.display = "none";
      inputField.style.display = "inline";
      inputField.value = displaySpan.textContent;
      button.style.display = "none";
      saveButton.style.display = "inline";
    }

    // 일반 필드 저장 (이름, 이메일)
    function saveField(button) {
      const item = button.closest(".profile-item");
      const fieldName = item.dataset.field;
      const inputField = item.querySelector(".field-input");
      const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

      const payload = {value: inputField.value};

      fetch(`/members/update/${fieldName}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          [csrfHeader]: csrfToken,
        },
        body: JSON.stringify(payload),
      })
              .then((response) => {
                if (response.ok) {
                  alert("수정되었습니다.");
                  if (fieldName === "email") {
                    // 이메일 수정 성공 시 로그인 페이지로 즉시 리다이렉트
                    alert("이메일이 변경되어 자동으로 로그아웃됩니다.");
                    // 로그아웃 처리 후 로그인 페이지로 이동
                    window.location.href = "/members/logout";
                  } else {
                    location.reload();
                  }
                } else {
                  return response.text().then(text => {
                    throw new Error(text);
                  });
                }
              })
              .catch((error) => {
                alert("수정 실패: " + error.message);
              });
    }

    // 주소 정보 저장
    function saveAddress() {
      const addressField = document.querySelector("#addressField");
      const postcodeField = document.querySelector("#postcodeField");
      const detailAddressField = document.querySelector("#detailAddressField");
      const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

      const payload = {
        address: addressField.value,
        postcode: postcodeField.value,
        detailAddress: detailAddressField.value,
      };

      fetch('/members/update/address', {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          [csrfHeader]: csrfToken,
        },
        body: JSON.stringify(payload),
      })
              .then((response) => {
                if (response.ok) {
                  alert("주소가 수정되었습니다.");
                  location.reload();
                } else {
                  return response.text().then(text => {
                    throw new Error(text);
                  });
                }
              })
              .catch((error) => {
                alert("주소 수정 실패: " + error.message);
              });
    }

    // 비밀번호 변경
    function savePassword() {
      const currentPassword = document.querySelector("#currentPassword").value;
      const newPassword = document.querySelector("#newPassword").value;
      const confirmPassword = document.querySelector("#confirmPassword").value;
      const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

      if (!currentPassword || !newPassword || !confirmPassword) {
        alert("모든 비밀번호 필드를 입력해주세요.");
        return;
      }

      if (newPassword !== confirmPassword) {
        alert("새 비밀번호가 일치하지 않습니다.");
        return;
      }

      const payload = {
        currentPassword: currentPassword,
        newPassword: newPassword,
        confirmPassword: confirmPassword,
      };

      fetch('/members/update/password', {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          [csrfHeader]: csrfToken,
        },
        body: JSON.stringify(payload),
      })
              .then((response) => {
                if (response.ok) {
                  alert("비밀번호가 변경되었습니다.");
                  document.querySelector("#currentPassword").value = "";
                  document.querySelector("#newPassword").value = "";
                  document.querySelector("#confirmPassword").value = "";
                } else {
                  return response.text().then(text => {
                    throw new Error(text);
                  });
                }
              })
              .catch((error) => {
                alert("비밀번호 변경 실패: " + error.message);
              });
    }
  </script>
</head>

<body>
<div class="profile-container">
  <h2>내 정보</h2>

  <!-- 가입 구분 -->
  <div class="profile-item">
    <label>가입 구분:</label>
    <span th:if="${member.role.name() == 'USER'}">일반 회원</span>
    <span th:if="${member.role.name() == 'MANAGER'}">판매자</span>
    <span th:if="${member.role.name() == 'ADMIN'}">관리자</span>
  </div>

  <!-- 이름 -->
  <div class="profile-item" data-field="name">
    <label>이름:</label>
    <span th:text="${member.name}" class="field-display"></span>
    <input type="text" class="field-input" style="display: none;" />
    <button type="button" class="edit-button" onclick="toggleEdit(this)">수정</button>
    <button type="button" class="save-button" style="display: none;" onclick="saveField(this)">저장</button>
  </div>

  <!-- 사업자 등록번호 (판매자만) -->
  <div class="profile-item" th:if="${member.role.name() == 'MANAGER'}">
    <label>사업자 등록번호:</label>
    <span th:if="${member.businessRegistrationNumber != null}"
          th:text="${member.businessRegistrationNumber}"></span>
    <span th:if="${member.businessRegistrationNumber == null}">
               등록된 사업자 등록번호가 없습니다.
           </span>
  </div>

  <!-- 이메일 -->
  <div class="profile-item" data-field="email">
    <label>이메일:</label>
    <span th:text="${member.email}" class="field-display"></span>
    <input type="email" class="field-input" style="display: none;" />
    <button type="button" class="edit-button" onclick="toggleEdit(this)">수정</button>
    <button type="button" class="save-button" style="display: none;" onclick="saveField(this)">저장</button>
    <p class="warning-text">이메일 수정시 로그아웃됩니다.</p>
  </div>


  <!-- 비밀번호 변경 -->
  <div class="password-change-section">
    <label>비밀번호 변경:</label>
    <div class="password-inputs">
      <div class="password-row" style="display: flex; align-items: center;">
        <input type="password" id="currentPassword" name="currentPassword" placeholder="기존 비밀번호" class="password-field field-input">
        <button type="button" class="password-change-btn" onclick="savePassword()">적용</button>
      </div>
      <div class="password-row">
        <input type="password" id="newPassword" name="newPassword" placeholder="새 비밀번호" class="password-field field-input">
        <input type="password" id="confirmPassword" name="confirmPassword" placeholder="새 비밀번호 확인" class="password-field field-input">
      </div>
    </div>
  </div>



  <!-- 주소 -->
  <div class="profile-item">
    <label>우편번호:</label>
    <input type="text" id="postcodeField" class="field-input" placeholder="우편번호"
           readonly th:value="${member.postcode}" />
  </div>


  <div class="profile-item" data-field="address">
    <label>주소:</label>
    <input type="text" id="addressField" class="field-input" placeholder="주소를 입력하세요"
           readonly th:value="${member.address}" />
    <button type="button" onclick="openPostcodePopup()">주소 찾기</button>
  </div>



  <div class="profile-item">
    <label>상세 주소:</label>
    <input type="text" id="detailAddressField" class="field-input" placeholder="상세 주소를 입력하세요"
           th:value="${member.detailAddress}" />
    <button type="button" onclick="saveAddress()">저장</button>
  </div>

  <a href="/" class="btn btn-primary">홈으로</a>
</div>
</body>
</html>