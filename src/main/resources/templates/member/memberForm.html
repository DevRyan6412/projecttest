<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">
<head>
  <title>회원가입</title>
  <th:block layout:fragment="css">
    <style>
      .fieldError {
        color: #bd2130;
      }
      .form-group {
        margin-bottom: 1.5rem;
      }
      .input-group {
        margin-bottom: 1rem;
      }
    </style>
  </th:block>
</head>
<body>
<th:block layout:fragment="script">
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  <script th:inline="javascript">
    function toggleRole() {
      const roleManager = document.getElementById("role-manager").checked;
      const businessSection = document.getElementById("business-section");
      const businessInput = document.getElementById("businessRegistrationNumber");

      businessSection.style.display = roleManager ? "block" : "none";
      if(roleManager) {
        businessInput.setAttribute("required", "required");
      } else {
        businessInput.removeAttribute("required");
        businessInput.value = "";
      }
    }

    // validateBusinessNumber 함수 추가 (toggleRole 함수 뒤에 추가)
    function validateBusinessNumber(input) {
      const errorElement = document.getElementById('business-number-error');
      const value = input.value;

      // 숫자만 입력되도록 처리
      input.value = value.replace(/[^0-9]/g, '');

      // 사업자 등록번호 길이 체크
      if (value.length > 0 && value.length !== 10) {
        errorElement.textContent = "사업자 등록번호는 10자리여야 합니다.";
        return false;
      } else {
        errorElement.textContent = "";
        return true;
      }
    }

    // validateForm 함수 수정 (기존 함수 교체)
    function validateForm() {
      let isValid = true;
      const emailValidated = document.getElementById("email-validated").value;
      const emailResultField = document.getElementById("email-check-result");

      if (emailValidated !== "true") {
        emailResultField.textContent = "이메일 중복확인은 필수입니다.";
        emailResultField.style.color = "red";
        isValid = false;
      }

      const requiredFields = document.querySelectorAll("input[required]");
      requiredFields.forEach(field => {
        const errorField = field.nextElementSibling;
        if (!field.value.trim()) {
          if (errorField) {
            errorField.textContent = `${field.placeholder}은(는) 필수 항목입니다.`;
            errorField.style.color = "red";
          }
          isValid = false;
        }
      });

      // 판매자 선택시 사업자번호 검증 추가
      const roleManager = document.getElementById("role-manager").checked;
      if (roleManager) {
        const businessNumber = document.getElementById("businessRegistrationNumber").value;
        if (businessNumber.length !== 10) {
          const errorElement = document.getElementById('business-number-error');
          errorElement.textContent = "사업자 등록번호는 10자리여야 합니다.";
          isValid = false;
        }
      }

      return isValid;
    }

    function checkEmail(event) {
      event.preventDefault();
      const emailField = document.getElementById("email");
      const resultField = document.getElementById("email-check-result");
      const emailValidatedField = document.getElementById("email-validated");
      const email = emailField.value;

      fetch(`/members/check-email?email=${encodeURIComponent(email)}`)
              .then(response => {
                if (!response.ok) throw new Error("이메일 중복 확인 실패");
                return response.json();
              })
              .then(isDuplicated => {
                resultField.textContent = isDuplicated ? "이미 사용 중인 이메일입니다." : "사용 가능한 이메일입니다.";
                resultField.style.color = isDuplicated ? "red" : "green";
                emailValidatedField.value = !isDuplicated;
              })
              .catch(error => {
                console.error(error);
                resultField.textContent = "중복 확인 중 오류가 발생했습니다.";
                resultField.style.color = "red";
                emailValidatedField.value = "false";
              });
    }

    function checkPasswordMatch() {
      const password = document.getElementById("password").value;
      const confirmPassword = document.getElementById("confirmPassword").value;
      const resultField = document.getElementById("password-check-result");

      if (!confirmPassword) {
        resultField.textContent = "";
        return;
      }

      resultField.textContent = password === confirmPassword ?
              "비밀번호가 일치합니다." : "비밀번호가 일치하지 않습니다.";
      resultField.style.color = password === confirmPassword ? "green" : "red";
    }

    function execDaumPostcode() {
      new daum.Postcode({
        oncomplete: function(data) {
          document.getElementById("postcode").value = data.zonecode;
          document.getElementById("address").value = data.roadAddress;
          document.getElementById("detailAddress").focus();
        }
      }).open();
    }

    window.onload = toggleRole;
  </script>
</th:block>

<div layout:fragment="content">
  <form action="/members/new" role="form" method="post" th:object="${memberFormDto}" onsubmit="return validateForm()">
    <div class="form-group">
      <label>가입 구분</label><br>
      <input type="radio" id="role-user" name="role" value="USER" checked onclick="toggleRole()"> 일반 회원
      <input type="radio" id="role-manager" name="role" value="MANAGER" onclick="toggleRole()"> 판매자
    </div>

    <div class="form-group">
      <label th:for="name">이름</label>
      <input type="text" th:field="*{name}" class="form-control" placeholder="이름을 입력해주세요" required>
      <p th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="fieldError"></p>
    </div>

    <div class="form-group" id="business-section">
      <label for="businessRegistrationNumber">사업자 등록번호</label>
      <input type="text"
             th:field="*{businessRegistrationNumber}"
             class="form-control"
             placeholder="사업자 등록번호 10자리를 입력해주세요"
             maxlength="10"
             oninput="validateBusinessNumber(this)">
      <p id="business-number-error" class="fieldError"></p>
    </div>

    <div class="form-group">
      <label th:for="email">이메일 주소</label>
      <div class="input-group">
        <input type="email" th:field="*{email}" placeholder="이메일을 입력해주세요" required>
        <button type="button" onclick="checkEmail(event)">중복 확인</button>
      </div>
      <p th:if="${#fields.hasErrors('email')}" th:errors="*{email}" class="fieldError"></p>
      <p id="email-check-result"></p>
      <input type="hidden" id="email-validated" value="false">
    </div>

    <div class="form-group">
      <label th:for="password">비밀번호</label>
      <input type="password" th:field="*{password}" class="form-control"
             placeholder="비밀번호 입력" required>
      <p th:if="${#fields.hasErrors('password')}" th:errors="*{password}" class="fieldError"></p>
    </div>

    <div class="form-group">
      <label th:for="confirmPassword">비밀번호 확인</label>
      <input type="password" id="confirmPassword" name="confirmPassword" class="form-control"
             placeholder="비밀번호를 다시 입력해주세요" oninput="checkPasswordMatch()" required>
      <p id="password-check-result"></p>
    </div>

    <div class="form-group">
      <label>주소</label>
      <div class="input-group">
        <input type="text" th:field="*{postcode}" class="form-control" placeholder="우편번호" readonly>
        <button type="button" class="btn btn-secondary" onclick="execDaumPostcode()">주소 검색</button>
      </div>
      <input type="text" th:field="*{address}" class="form-control" placeholder="주소" readonly>
      <input type="text" th:field="*{detailAddress}" class="form-control"
             placeholder="상세 주소를 입력해주세요" required>
    </div>

    <div style="text-align: center;">
      <button type="submit" class="btn btn-dark">회원가입</button>
    </div>

    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
  </form>
</div>
</body>
</html>